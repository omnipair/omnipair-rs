name: Verify Build

on:
  workflow_dispatch:
    inputs:
      program_id:
        description: 'Program ID to verify (optional - defaults to value from lib.rs)'
        required: false
        type: string
      cluster:
        description: 'Cluster to verify against'
        required: true
        type: choice
        options:
          - mainnet
          - devnet
        default: mainnet

env:
  ANCHOR_VERSION: '0.31.1'
  SOLANA_VERSION: '1.18.18'

jobs:
  verify-build:
    runs-on: ubuntu-22.04
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Determine Program ID
        run: |
          # Extract from source as default
          EXTRACTED_ID=$(grep 'declare_id!' programs/omnipair/src/lib.rs | sed 's/declare_id!("//;s/");$//')
          # Use input if provided, otherwise use extracted value
          PROGRAM_ID="${{ inputs.program_id }}"
          if [ -z "$PROGRAM_ID" ]; then
            PROGRAM_ID="$EXTRACTED_ID"
            echo "Using Program ID from lib.rs: $PROGRAM_ID"
          else
            echo "Using provided Program ID: $PROGRAM_ID"
          fi
          echo "PROGRAM_ID=$PROGRAM_ID" >> $GITHUB_ENV

      - name: Setup Anchor
        uses: metadaoproject/setup-anchor@v3
        with:
          anchor-version: ${{ env.ANCHOR_VERSION }}
          solana-cli-version: ${{ env.SOLANA_VERSION }}

      - name: Cache Cargo registry
        uses: actions/cache@v4
        with:
          path: |
            ~/.cargo/registry/index/
            ~/.cargo/registry/cache/
            ~/.cargo/git/db/
          key: cargo-${{ runner.os }}-${{ hashFiles('**/Cargo.lock') }}

      - name: Cache solana-verify
        uses: actions/cache@v4
        id: cache-solana-verify
        with:
          path: ~/.cargo/bin/solana-verify
          key: cargo-${{ runner.os }}-solana-verify-v0.3

      - name: Install solana-verify
        if: steps.cache-solana-verify.outputs.cache-hit != 'true'
        run: cargo install solana-verify

      - name: Determine cluster flag
        id: cluster
        run: |
          if [ "${{ inputs.cluster }}" = "mainnet" ]; then
            echo "flag=-um" >> $GITHUB_OUTPUT
          else
            echo "flag=-ud" >> $GITHUB_OUTPUT
          fi

      - name: Verify build
        run: |
          echo "============================================"
          echo "Verifying omnipair against on-chain program"
          echo "Program ID: ${{ env.PROGRAM_ID }}"
          echo "Cluster: ${{ inputs.cluster }}"
          echo "============================================"
          solana-verify verify-from-repo \
            --remote \
            ${{ steps.cluster.outputs.flag }} \
            --program-id ${{ env.PROGRAM_ID }} \
            https://github.com/${{ github.repository }} \
            --library-name omnipair \
            --bpf-flag "features=production"
