name: generate-verifiable-builds

on:
  workflow_dispatch:
  push:
    branches:
      - main

env:
  ANCHOR_VERSION: '0.31.1'
  SOLANA_VERSION: '1.18.18'

jobs:
  generate-verifiable-omnipair:
    runs-on: ubuntu-22.04
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Get build info
        id: info
        run: |
          SHA=$(git rev-parse HEAD)
          SHORT_SHA=$(git rev-parse --short HEAD)
          TAG=$(git describe --tags --exact-match 2>/dev/null || echo "dev-${SHORT_SHA}")
          echo "sha=$SHA" >> $GITHUB_OUTPUT
          echo "tag=$TAG" >> $GITHUB_OUTPUT

      - uses: metadaoproject/anchor-verifiable-build@v0.4
        with:
          program: omnipair
          anchor-version: ${{ env.ANCHOR_VERSION }}
          solana-cli-version: ${{ env.SOLANA_VERSION }}
          features: 'production'
        env:
          GIT_REV: ${{ steps.info.outputs.sha }}
          GIT_RELEASE: ${{ steps.info.outputs.tag }}

      - name: List build artifacts
        run: |
          ls -la target/deploy/ || echo "target/deploy does not exist"
          ls -la target/idl/ || echo "target/idl does not exist"

      - name: Verify security.txt embedded
        run: |
          echo "Checking security.txt in binary..."
          strings target/deploy/omnipair.so | grep -E "(source_release|source_revision)" || true

      - run: git pull --rebase

      - run: mkdir -p verifiable-builds && cp target/deploy/omnipair.so ./verifiable-builds/

      - name: Commit verifiable build
        uses: EndBug/add-and-commit@v9
        with:
          default_author: github_actions
          message: 'chore: update omnipair verifiable build (${{ steps.info.outputs.tag }})'
          add: 'verifiable-builds/*'
