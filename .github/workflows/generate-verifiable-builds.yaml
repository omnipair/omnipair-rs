name: generate-verifiable-builds

on:
  workflow_dispatch:
  push:
    branches:
      - main

env:
  ANCHOR_VERSION: '0.31.1'

permissions:
  contents: write

jobs:
  generate-verifiable-omnipair:
    runs-on: ubuntu-22.04
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Get build info
        id: info
        run: |
          SHA=$(git rev-parse HEAD)
          SHORT_SHA=$(git rev-parse --short HEAD)
          TAG=$(git describe --tags --exact-match 2>/dev/null || echo "dev-${SHORT_SHA}")
          echo "sha=$SHA" >> $GITHUB_OUTPUT
          echo "tag=$TAG" >> $GITHUB_OUTPUT

      - name: Install Anchor CLI
        run: |
          cargo install --git https://github.com/coral-xyz/anchor --tag v${{ env.ANCHOR_VERSION }} anchor-cli --locked
          anchor --version

      - name: Build verifiable
        run: |
          anchor build --verifiable -p omnipair \
            -e GIT_REV=${{ steps.info.outputs.sha }} \
            -e GIT_RELEASE=${{ steps.info.outputs.tag }} \
            -- --features "production"

      - name: List build artifacts
        run: |
          echo "=== target/verifiable ==="
          ls -la target/verifiable/ || echo "target/verifiable does not exist"
          echo "=== target/deploy ==="
          ls -la target/deploy/ || echo "target/deploy does not exist"
          echo "=== target/idl ==="
          ls -la target/idl/ || echo "target/idl does not exist"

      - name: Verify security.txt embedded
        run: |
          SO_FILE=$(find target -name "omnipair.so" | head -1)
          echo "Found: $SO_FILE"
          strings "$SO_FILE" | grep -E "(source_release|source_revision)" || true

      - run: git pull --rebase

      - name: Copy build artifacts
        run: |
          mkdir -p verifiable-builds
          SO_FILE=$(find target -name "omnipair.so" | head -1)
          cp "$SO_FILE" ./verifiable-builds/

      - name: Commit verifiable build
        uses: EndBug/add-and-commit@v9
        with:
          default_author: github_actions
          message: 'chore: update omnipair verifiable build (${{ steps.info.outputs.tag }})'
          add: 'verifiable-builds/*'
