name: generate-verifiable-builds

on:
  workflow_dispatch:
  push:
    branches:
      - main

env:
  ANCHOR_VERSION: '0.31.1'
  SOLANA_VERSION: '1.18.18'

jobs:
  generate-verifiable-omnipair:
    runs-on: ubuntu-22.04
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Get build info
        id: info
        run: |
          SHA=$(git rev-parse HEAD)
          SHORT_SHA=$(git rev-parse --short HEAD)
          TAG=$(git describe --tags --exact-match 2>/dev/null || echo "dev-${SHORT_SHA}")
          echo "sha=$SHA" >> $GITHUB_OUTPUT
          echo "short_sha=$SHORT_SHA" >> $GITHUB_OUTPUT
          echo "tag=$TAG" >> $GITHUB_OUTPUT

      - name: Setup Anchor
        uses: metadaoproject/setup-anchor@v3
        with:
          anchor-version: ${{ env.ANCHOR_VERSION }}
          solana-cli-version: ${{ env.SOLANA_VERSION }}

      - name: Build verifiable
        run: |
          anchor build --verifiable -p omnipair \
            -e GIT_REV=${{ steps.info.outputs.sha }} \
            -e GIT_RELEASE=${{ steps.info.outputs.tag }} \
            -- --features "production"

      - name: Verify security.txt embedded
        run: |
          SO_FILE=$(find target -name "omnipair.so" | head -1)
          echo "Found: $SO_FILE"
          echo "=== Build Info ==="
          echo "Tag: ${{ steps.info.outputs.tag }}"
          echo "Commit: ${{ steps.info.outputs.sha }}"
          echo "=== Security.txt ==="
          strings "$SO_FILE" | grep -E "(source_release|source_revision)" || true

      - name: Upload build artifacts
        uses: actions/upload-artifact@v4
        with:
          name: omnipair-${{ steps.info.outputs.short_sha }}
          path: |
            target/deploy/omnipair.so
            target/idl/omnipair.json
          retention-days: 90
